<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:app="http://www.appcelerator.org" xmlns:google="http://www.appcelerator.org">
<head>
    <noscript><meta http-equiv="refresh" content="0;upgrade_script.html"/></noscript>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="description" content="WishaLista is a simple utility to managing your wish lists and sharing them with your friends"/>
    <meta name="keywords" content="wishlist,web2.0,appcelerator,friends,socialmedia,purchase,socialtransactions" />
    <title>WishaLista</title>
    <link rel="shortcut icon" href="favicon.ico"/>
    <link rel="icon" href="favicon.ico"/>
    <link rel="stylesheet" href="css/main.css" type="text/css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" href="css/items.css" type="text/css" media="screen" charset="utf-8"/>
    <script type="text/javascript" src="js/appcelerator.js"></script>
    <script type="text/javascript" src="js/user.js"></script>
    <script type="text/javascript" src="js/builder.js"></script>
    <script type="text/javascript" src="js/cropper.js"></script>
</head>
<body style="visibility:hidden" on="l:app.compiled then visible">
    <div id="header">
        <div id="header_content">
            <img src="images/banner_badge.png" alt="Wishalista" /> 
            <span id="header_content_welcome">Welcome back, <a on="r:wl.list.item.response[success=true] then value[my_firstname]" id="my_profile">...</a></span>
            <span id="header_content_logout">
                <a href="index.html">Home</a> |
                <a href="main.html">Profile</a> |
                <a href="#" on="click then r:wl.logout.request">Logout</a>
            </span>
        </div>
    </div>
    <div id="content_header"></div>
    <div id="content">
        <div id="content_body">
              <div id="error" style="display:none" on="r:~.*[success=false] then effect[appear] or l:error.close then hide">
                  <div id="error_closer" on="click then l:error.close">
                      <img src="images/dialog_close.gif"/>
                  </div>
                  <div>
                      <img src="images/exclamation.png" />
                      <span on="r:~.*[success=false] then value[message]"></span>
                  </div>
              </div>
            <div on="r:wl.list.item.response[success=true] then show else hide" style="display:none">
	            <form on="enter then r:wl.search.request[query=$search] if expr[$('search').value] or content[picture] then hide else show">
	                 <div id="searchbox" on="click then r:wl.search.request[query=$search] if expr[$('search').value]"><input type="text" value="" id="search"/></div>
	            </form>
	            <table border="0" cellpadding="0" cellspacing="0" width="100%">
	                <tr valign="top">
	                    <td width="20%">
	                        <div id="mypicture">
	                            <div id="profile_picture_container" on="click then l:update.picture if expr[user_id==$('my_user_id').value]">
										<img id="profile_picture" src="images/picture.gif"/>
								</div>
	                            <div id="mypicture_footer">
	                                <div><h1 on="r:wl.list.item.response[success=true] then value[name]"></h1></div>
	                                <div on="r:wl.list.item.response[isMe=true] then show else hide"><a on="click then l:edit.profile">edit your profile</a></div>
	                                <div on="r:wl.list.item.response[isMe=false,friended!=true] then show else hide"><a on="click then r:wl.friend.add.request[friend_id=$user_id]"><img src="images/user_add.png"/> add as friend</a></div>
	                                <div on="r:wl.list.item.response[isMe=false,friended=true] then show else hide"><img src="images/user.png"/> your friend</div>
	                            </div>
	                        </div>
	                    </td>
	                    <td width="40%">
	                        <div id="mylist" on="content[list] then show else hide">
	                            <div id="mylist_header"></div>
	                            <div id="mylist_header_content">
	                                <h1 id="mylist_header_title"></h1>
	                                <div class="button" on="click then l:send.list or r:wl.list.item.response[isMe=true] then show else hide" style="display:none">send list</div>
	                            </div>
	                            <div id="mylist_content">
	                                <div id="mylist_content_body">
	                                    <div>
	                                        <div on="r:wl.list.item.response then hide">Loading list...</div>
	                                        <div on="r:wl.list.item.response[length=0,isMe=true] then show else hide" style="display:none">
	                                            You have no items in your list.  <a on="click then l:create.item">Why not add some?</a>
	                                        </div>
	                                        <div on="r:wl.list.item.response[length=0,isMe=false] then show else hide" style="display:none">
	                                            <span on="r:wl.list.item.response[length=0,isMe=false] then value[firstname]"></span> has not added any items yet. 
	                                        </div>
									        <app:iterator on="r:wl.list.item.response[success=true,length!=0] then execute" property="items">
									            <html:div class="item_list" on="r:wl.remove.item.response[success=true,item_id=#{item_id}] then effect[Fade]">
									                    <html:table style="clear:both;" border="0" width="100%" cellpadding="0" cellpadding="0">
									                       <html:tr valign="top"> 
                                                               <html:td align="left">
									                               <html:span class="user_controls_me_#{isMe}">
	  			                                                         <html:span 
			                                                              class="icon"
			                                                              on='click then r:wl.remove.item.request[item_id=#{item_id}] 
			                                                                if expr[confirm("Are you sure you want to delete this item?")]'>
			                                                                <html:img src="images/delete.png"></html:img>
				                                                         </html:span>
		                                                                    <html:span 
	                                                                        class="icon" 
	                                                                        on='click then l:wl.expand.edit[item_id=#{item_id}]'>
	                                                                            <html:img src="images/pencil.png"></html:img>
	                                                                    </html:span>
	                                                               </html:span>
	                                                               <html:span class="other_user_controls_me_#{isMe} #{state}">
                                                                    <html:span
                                                                        class="icon edit claim"
                                                                        on='click then r:wl.claim.item.request[item_id=#{item_id}]'>
                                                                            <html:img src="images/asterisk_orange.png"></html:img>
                                                                    </html:span>
                                                                    <html:span 
                                                                        class="icon edit purchase" 
                                                                        on='click then r:wl.purchase.item.request[item_id=#{item_id}]'>
                                                                            <html:img src="images/money.png"></html:img>
                                                                    </html:span>
	                                                               </html:span>
                                                               </html:td>
			                                                   <html:td align="left" width="80%">
				                                                    <html:div 
				                                                        class="name claimed_#{claimed} purchased_#{bought}" 
				                                                        on="click then l:wl.expand.description[item_id=#{item_id}]">
				                                                        #{name}
				                                                    </html:div>
                                                               </html:td>
                                                               <html:td align="right" class="#{state}">
                                                                    <html:span
                                                                        class="icon claimed_icon"
                                                                        on="click then r:wl.unclaim.item.request[item_id=#{item_id}] if expr[$('my_user_id').value=='#{claimed_user_id}' &amp;&amp; confirm('Are you sure you want to unclaim this item?')]">
                                                                            <html:img src="images/asterisk_orange.png"></html:img>
                                                                    </html:span>
                                                                    <html:span 
                                                                        class="icon purchased_icon" 
                                                                        on="click then r:wl.unpurchase.item.request[item_id=#{item_id}] if expr[$('my_user_id').value=='#{claimed_user_id}' &amp;&amp; confirm('Are you sure you want to unpurchase this item?')]">
                                                                            <html:img src="images/money.png"></html:img>
                                                                    </html:span>
                                                               </html:td>
        							                       </html:tr>
									                    </html:table>
                                                        <html:div 
                                                            class="description" 
                                                            on="l:wl.expand.description[item_id=#{item_id}] then toggle[display]" 
                                                            style="display: none;">
                                                            <html:p>#{note}</html:p>
                                                        </html:div>
									            </html:div>
									            <html:div style="display: none" class="edit_item" on="l:wl.expand.edit[item_id=#{item_id}] then toggle[display]">
	                                                <html:input type="hidden" name="item_id" fieldset="#{item_id}" value="#{item_id}"></html:input>
									                <html:table>
	    								                <html:tr>
		   							                      <html:td>Name:</html:td>
									                      <html:td><html:input type="text" fieldset="#{item_id}" name="name" value="#{name}"></html:input></html:td>
									                    </html:tr>
	                                                    <html:tr>
	                                                      <html:td>Occasion</html:td>                                               
	                                                      <html:td><html:input type="text" fieldset="#{item_id}" name="occasion" value="#{occasion}"></html:input></html:td>
	                                                    </html:tr>
									                    <html:tr>
									                      <html:td>Note:</html:td>
									                      <html:td><html:textarea fieldset="#{item_id}" name="note">#{note}</html:textarea></html:td>
									                    </html:tr>
	                                                    <html:tr>
	                                                      <html:td>
	                                                        <html:div class="edit_button" fieldset="#{item_id}" on="click then r:wl.edit.item.request"><html:a>Update</html:a></html:div>
	                                                      </html:td>                                               
	                                                      <html:td>
	                                                        <html:div style="margin-left:10px;" class="edit_button" on="click then l:wl.expand.edit[item_id=#{item_id}]"><html:a>Close</html:a></html:div>
	                                                      </html:td>                                               
	                                                    </html:tr>
									                </html:table>
									            </html:div>
									        </app:iterator>
	                                    </div>
	                                    <div id="mylist_add" style="display:none" on="r:wl.list.item.response[isMe=true] then show else hide"><div id="mylist_add_button" on="click then l:create.item">Add something to my Wisha Lista!</div></div>
	                                </div>
	                            </div>
	                        </div>
	                        <div id="edit" style="display:none" on="content[edit] then show else hide">
	                            <div class="body_header"></div>
	                            <div class="body_header_content"><h1>Edit My Profile</h1></div>
	                            <div class="body_content">
	                                <div class="body_content_body">
	                                    <form on="enter then l:save.profile or r:wl.profile.edit.request then disable or r:wl.profile.edit.response then enable">
		                                    <table width="100%" cellspacing="10">
		                                       <tr>
		                                        <td>First Name:</td>
		                                        <td><input type="text" id="editprofile_firstname" validator="required" name="firstname" on="r:wl.list.item.response[isMe=true] then value[my_firstname]" fieldset="profile"></td>
		                                       </tr>
		                                       <tr>
		                                        <td>Last Name:</td>
		                                        <td><input type="text" id="editprofile_lastname" validator="required" name="lastname" on="r:wl.list.item.response[isMe=true] then value[my_lastname]" fieldset="profile"></td>
		                                       </tr>
		                                       <tr>
		                                        <td>Email:</td>
		                                        <td><input type="text" id="editprofile_email" validator="email" name="email" on="r:wl.list.item.response[isMe=true] then value[my_email]" fieldset="profile"/></td>
		                                       </tr>
		                                       <tr>
		                                        <td>Password:</td>
		                                        <td><input type="password" id="editprofile_pwd" validator="password" name="password" fieldset="profile"/></td>
		                                       </tr>
		                                    </table>
		                                    <table cellspacing="10">
		                                        <tr>
		                                            <td><div class="button" activators="editprofile_firstname,editprofile_lastname,editprofile_email,editprofile_pwd" id="save_profile_btn"
		                                            on="click then r:wl.profile.edit.request or l:save.profile then r:wl.profile.edit.request if expr[!$('save_profile_btn').disabled]" fieldset="profile" id="save_profile">save</div></td>
		                                            <td><div class="button" on="click then l:show.list">close</div></td>
		                                        </tr>
		                                    </table>
	                                    </form>
	                                </div>
		                            <div>
		                                <img src="images/indicator_web2.3.gif" style="display: none;" class="indicator"
		                                    on="r:wl.profile.edit.request then show or r:wl.profile.edit.response then hide"/>
		                            </div>
		                            <div on="r:wl.profile.edit.request then hide or r:wl.profile.edit.response[success=true] then show or r:wl.profile.edit.response[success=true] then effect[fade] after 2s" style="display:none" class="flash">
		                                <img src="images/confirm.png"/> <span on="r:wl.profile.edit.response then value[message]"></span>
		                            </div>
	                            </div>
	                        </div>
	                        <div id="send" style="display:none" on="content[send] then show else hide">
	                            <div class="body_header"></div>
	                            <div class="body_header_content"><h1>Send MyLista to a Frienda</h1></div>
	                            <div class="body_content">
	                                <div class="body_content_body">
	                                    <form on="enter then l:send_email if expr[$('sendlist_email').value]">
		                                    <table width="100%" cellspacing="10">
		                                       <tr>
		                                        <td>Email:</td>
		                                        <td>
		                                            <div style="height:30px;">
		                                                <div><input name="email_to" id="sendlist_email" fieldset="sendlist" validator="email" decorator="custom" decoratorId="sendlist_email_dec"/></div>
		                                                <div id="sendlist_email_dec" class="field_decorator">Please enter a valid email address</div>
		                                            </div>
		                                        </td>
		                                       </tr>
		                                    </table>
		                                    <table cellspacing="10">
		                                        <tr>
		                                            <td><div class="button" activators="sendlist_email" on="click then r:wl.email_list.request or l:send_email then r:wl.email_list.request" 
		                                               fieldset="sendlist">send</div></td>
		                                            <td><div class="button" on="click then l:show.list">close</div></td>
		                                        </tr>
		                                    </table>
		                                </form>
	                                </div>
	                                <div>
	                                    <img src="images/indicator_web2.3.gif" style="display: none;" class="indicator"
	                                        on="r:wl.email_list.request then show or r:wl.email_list.response then hide"/>
	                                </div>
	                                <div on="r:wl.email_list.request then hide or r:wl.email_list.response[success=true] then show or r:wl.email_list.response[success=true] then effect[fade] after 2s" style="display:none" class="flash">
	                                    <img src="images/confirm.png"/> <span on="r:wl.email_list.response then value[message]"></span>
	                                </div>
	                            </div>
	                        </div>
	                        <div id="create" style="display:none" on="content[create] then show else hide">
	                            <div class="body_header"></div>
	                            <div class="body_header_content"><h1>Add Item to MyLista</h1></div>
	                            <div class="body_content">
	                                <div class="body_content_body">
	                                    <form on="enter then l:add.item or r:wl.add.item.request then disable or r:wl.add.item.response then enable">
		                                    <table width="100%" cellspacing="10">
		                                       <tr>
		                                        <td>Name:</td>
		                                        <td>
		                                            <input name="name" id="create_name" fieldset="create" validator="required"/>
		                                        </td>
		                                       </tr>
		                                       <tr>
		                                        <td>Occasion:</td>
		                                        <td>
		                                            <input name="occasion" id="create_occasion" fieldset="create" validator="required"/>
		                                        </td>
		                                       </tr>
		                                       <tr>
		                                        <td>Note:</td>
		                                        <td>
		                                            <textarea cols="20" rows="4" name="note" id="create_note" fieldset="create" validator="required"></textarea>
		                                        </td>
		                                       </tr>
		                                    </table>
		                                    <table cellspacing="10">
		                                        <tr>
		                                            <td><div class="button" activators="create_name,create_occasion,create_note" id="add_item_btn"
		                                               on="click then r:wl.add.item.request or l:add.item then r:wl.add.item.request if expr[!$('add_item_btn').disabled]" 
		                                               fieldset="create">add</div>
		                                            </td>
		                                            <td><div class="button" on="click then l:show.list">close</div></td>
		                                        </tr>
		                                    </table>
		                               </form>
	                                </div>
	                                <div>
	                                    <img src="images/indicator_web2.3.gif" style="display: none;" class="indicator"
	                                        on="r:wl.add.item.request then show or r:wl.add.item.response then hide"/>
	                                </div>
	                                <div on="r:wl.add.item.request then hide or r:wl.add.item.response[success=true] then show or r:wl.add.item.response[success=true] then effect[fade] after 2s" style="display:none" class="flash">
	                                    <img src="images/confirm.png"/> <span on="r:wl.add.item.response then value[message]"></span>
	                                </div>
	                            </div>
	                        </div>
                            <div id="picture" style="display:none" on="content[picture] then show else hide">
                                <div class="body_header_content" style="width:700px"><h1>Edit your profile picture</h1></div>
                                <div class="body_content" style="width:700px">
                                    <div class="body_content_body">
	
									    <app:upload action="-/fileupload" maxsize="3145728" on="r:wl.profile.picture.upload.response[success=true] then hide or content[picture] then show or l:image.upload.start then submit and disable or r:wl.profile.picture.upload.response then enable" service="wl.profile.picture.upload.request">
									        <html:span id="uploadtext">Select a picture: </html:span>
									        <html:input type="file" value="" id="file" name="filename" on="r:wl.profile.picture.upload.response[success=true] then clearform"></html:input>
									        <html:input type="button" value="Upload" id="upload" on="click then l:image.upload.start if expr[$('file').value!='']"></html:input>
									    </app:upload>
										
										<div style="display:none;text-align:right;" on="r:wl.profile.picture.upload.response[success=true] then show or content[picture] then hide">
											<div class="button" on="click then l:save.picture">Save</div>
										</div>
										<div style="width:690px;height:400px;overflow:auto;"><img id="imagePreview"/></div>
										
										<input type="hidden" id="x1" value=""/>
										<input type="hidden" id="x2" value=""/>
										<input type="hidden" id="y1" value=""/>
										<input type="hidden" id="y2" value=""/>
										<input type="hidden" id="width" value=""/>
										<input type="hidden" id="height" value=""/>
										
										<app:script on="l:save.picture then execute">
											$MQ('r:wl.profile.picture.crop.request',
											{
												'x1':$('x1').value,
												'x2':$('x2').value,
												'y1':$('y1').value,
												'y2':$('y2').value,
												'width':$('width').value,
												'height':$('height').value
											});
											if (window.preview)
											{
												window.preview.remove();
												delete window.preview;
											}
										</app:script>
										
									    <app:script on="r:wl.profile.picture.upload.response[success=true] then execute">
											var name = this.data.path;
									       	var path = Appcelerator.DocumentPath + name;
											$('imagePreview').onload = function()
											{
												function onEndCrop( coords, dimensions ) {
													$( 'x1' ).value = coords.x1;
													$( 'y1' ).value = coords.y1;
													$( 'x2' ).value = coords.x2;
													$( 'y2' ).value = coords.y2;
													$( 'width' ).value = dimensions.width;
													$( 'height' ).value = dimensions.height;
												}

												window.preview = new Cropper.ImgWithPreview( 
										            'imagePreview',
										            { 
										                minWidth: 157, 
										                minHeight: 189,
										                ratioDim: { x: 157, y: 189 },
										                displayOnInit: true, 
														onEndCrop:onEndCrop,
										                previewWrap: 'profile_picture_container'
										            } 
										        );
											};
											$('imagePreview').src=path;
									    </app:script>
                                    </div>
                            </div>
	                    </td>
	                    <td width="40%" on="content[picture] then hide else show">
	                        <div id="myfriends">
	                            <div id="myfriends_header">
	                                <h1 id="myfriends_title"></h1>
	                            </div>
	                            <div id="myfriends_content">
	                                <div id="searchresults">
	                                    <app:iterator on="r:wl.search.response[success=true,length!=0] then execute and show else hide or
	                                        r:wl.friends.get.response[success=true,length!=0] then execute and show else hide" 
	                                        property="results" style="display:none">
	                                        <html:div class="search_result">
	                                           <html:div><html:img src="images/small_picture.gif"></html:img></html:div>
	                                           <html:div><html:a href="#{path}">#{name}</html:a></html:div>
	                                        </html:div>
	                                    </app:iterator>
	                                    <div on="r:wl.search.response[length=0] then show else hide" class="search_noresults" style="display:none">Oops, we didn't find any matches. Refine your search and try again...</div>
	                                    <div on="r:wl.friends.get.response[length=0] then show else hide or r:wl.search.response then hide" class="search_noresults" style="display:none">
	                                        <span id="friend_search_title"></span>
	                                    </div>
	                                </div>
	                            </div>
	                        </div>
	                    </td>
	                </tr>
	            </table>
	        </div>
	   </div>
    </div>
    <div id="content_footer"></div>
    <div id="footer">
        <table width="100%">
            <tr>
                <td align="left"><small>Copyright &copy; 2007 by <a href="http://www.appcelerator.com">Appcelerator, Inc.</a> All Rights Reserved.</small></td>
                <td align="right"><a href="http://www.appcelerator.org"><img align="right" alt="Appcelerator" src="images/poweredby.png"/></a></td>
            </tr>
        </table>
    </div>
    
    
    <input type="hidden" id="user_id" value=""/>
    <input type="hidden" id="my_user_id" value="" on="r:wl.list.item.response then value[my_userid]"/>
    <app:script>$('user_id').value=user_id</app:script>
    
    <app:script on="r:wl.list.item.response[success=true] then execute">
	  if (this.data.picture) $('profile_picture').src = Appcelerator.DocumentPath + this.data.picture;
      $('mylist_header_title').innerHTML = (this.data.isMe ? 'My' : this.data.firstname+"'s")  +  ' Wisha List';
      $('myfriends_title').innerHTML = (this.data.isMe ? 'My' : this.data.firstname+"'s")  +  ' Homies';
      $('my_profile').href = Appcelerator.DocumentPath + 'main.html?id=' + this.data.my_userid;
      $('friend_search_title').innerHTML = this.data.isMe ? 'You have no friends yet. Why not invite someone?' : this.data.firstname + ' has no friends yet.';
    </app:script>
    
    <app:script on="r:wl.logout.response then execute">
        window.location.href = Appcelerator.DocumentPath + 'index.html';
    </app:script>
    
    <app:script on="r:wl.add.item.response[success=true] then r:wl.list.item.request[user_id=$user_id]"></app:script>
    <app:script on="r:wl.friend.add.response[success=true] then r:wl.list.item.request[user_id=$user_id]"></app:script>
    <app:script on="r:wl.claim.item.response[success=true] then r:wl.list.item.request[user_id=$user_id]"></app:script>
    <app:script on="r:wl.unclaim.item.response[success=true] then r:wl.list.item.request[user_id=$user_id]"></app:script>
    <app:script on="r:wl.purchase.item.response[success=true] then r:wl.list.item.request[user_id=$user_id]"></app:script>
    <app:script on="r:wl.unpurchase.item.response[success=true] then r:wl.list.item.request[user_id=$user_id]"></app:script>


    <app:script on="r:wl.search.response[success=true] then execute">
      $('myfriends_title').innerHTML = 'Search Results';
    </app:script>

    <app:statemachine id="content" initial="list">
       <state name="list" if="l:show.list or r:wl.profile.picture.crop.response"></state>
       <state name="edit" if="l:edit.profile"></state>
       <state name="send" if="l:send.list"></state>
       <state name="create" if="l:create.item"></state>
       <state name="picture" if="l:update.picture"></state>
    </app:statemachine>
    
    <app:message name="r:wl.list.item.request" args="{user_id:user_id}"></app:message>
    <app:message name="r:wl.profile.info.request"></app:message>
    <app:message name="r:wl.friends.get.request" args="{user_id:user_id}"></app:message>

</body>
</html>