require 'pathname'
require 'erb'
require 'md5'
require 'socket'
require 'fileutils'

app_path = ARGV.first
system('rails ' + app_path + ' >> rails.log')
FileUtils.rm_r 'rails.log'
p = Pathname.new(app_path)

secret_auth_key = Digest::MD5.hexdigest(Time.new.to_s + self.inspect + IPSocket.getaddress(Socket::gethostname).to_s)   

# 
# remove rails files
#
FileUtils.rm_r "#{p}/public/javascripts"

#
# add appcelerator files
#
APP_GEM = Gem.cache.search('appcelerator').last.full_gem_path
FileUtils.mkdir "#{p}/public/javascripts"
FileUtils.mkdir "#{p}/app/services"

FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/appcelerator.xml", "#{p}/public"
rails_gem = Gem.cache.search('rails').last
if rails_gem.version.to_s.to_f >= 2
  FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/application.rb", "#{p}/app/controllers"
end
f = File.open("#{p}/config/environment.rb", 'a')
f.write("\n\nrequire 'appcelerator'")
f.close
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/generate", "#{p}/script"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/index.html", "#{p}/public"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/images", "#{p}/public"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/javascripts", "#{p}/public"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/modules", "#{p}/public"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/README", "#{p}"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/routes.rb", "#{p}/config"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/service_broker_controller.rb", "#{p}/app/controllers"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/upload_controller.rb", "#{p}/app/controllers"
result = ERB.new(File.read("#{p}/app/controllers/service_broker_controller.rb")).result(binding)
f = File.new("#{p}/app/controllers/service_broker_controller.rb",'w')
f.write(result)
f.close
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/service_broker_helper.rb", "#{p}/app/helpers"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/servicetester.html", "#{p}/public"
FileUtils.cp_r "#{APP_GEM}/appcelerator/templates/test_service.rb", "#{p}/app/services"

puts "Successfully created new Appcelerator project in '#{app_path}'"