<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:app="http://appcelerator.org">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="../appcelerator/appcelerator-debug.js"></script>
	<link rel="stylesheet" type="text/css" href="../css/test.css" />
    <script>
		window.someGlobalVariable = 'Test passed';
    	window.someGlobalFunction = function(){ return 'Test passed'; };
	</script>
</head>
<body>

<h3> Advanced Expressions </h3> 
<p>
	These tests exercise advanced expressions 
</p>

<table width="90%">
	<tr>
		<td class="test" valign="middle">
			Multiple Expressions (5)
		</td>
		<td class="result">
			<a on="click then l:test1">Hide</a> |
			<a on="click then l:test2">Show</a> | 
			<a on="click then l:test3">Pulsate</a>
			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" on="l:test1 then hide
				or l:test2 then show
				or l:test3 then effect[Pulsate]
				or click then script[alert('yo')]
				or mouseover then set[border='1px solid red']">
				Click me to see an alert.
				Mouseover to change my border
			</div>
		</td>
	</tr>
	<tr>
		<td class="test" valign="middle">
			Multiple Actions (5)
		</td>
		<td class="result">
			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px" 
				on="click then script[alert('yo')] and set[border='1px solid red'] 
				and effect[Pulsate] and  set[color=green] and set[innerHTML='it worked'] ">
				Click me to see an alert, change my border, pulsate me, change my text
				and change my color to green
			</div>
		</td>
	</tr>
	<tr>
		<td class="test" valign="middle">
			"After" Test (unit=s)
		</td>
		<td class="result">
			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px" 
				on="click then effect[Fade] after 2s ">
				Click me and I will disappear after 2 seconds
			</div>
		</td>
	</tr>
	<tr>
		<td class="test" valign="middle">
			"After" Test (unit=ms)
		</td>
		<td class="result">
			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px" 
				on="click then effect[Fade] after 1500ms ">
				Click me and I will disappear after 1.5 seconds
			</div>
		</td>
	</tr>
	<tr>
		<td class="test" valign="middle">
			"After" Test (unit=notdefined)
		</td>
		<td class="result">
			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px" 
				on="click then effect[Fade] after 3100 ">
				Click me and I will disappear after 3.1 seconds
			</div>
		</td>
	</tr>

	<tr>
		<td class="test" valign="middle">
			"If" Test
		</td>
		<td class="result">
			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px" 
				on="click then script[alert('yo')] and set[border='1px solid red'] 
				and effect[Pulsate] and  set[color=green] and set[innerHTML='it worked']
				if expr[confirm('hide me?')] ">
				Click me to see an alert, change my border, pulsate me, change my text
				and change my color to green (only if you say so)
			</div>
		</td>
	</tr>
	<tr>
		<td class="test" valign="middle">
			"else" Test (message)
		</td>
		<td class="result">
			<a on="click then l:green[turn=true]">Turn color green</a> |
			<a on="click then l:green[turn=false]">Turn color blue</a> 

			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" 
				on="l:green[turn=true] then set[color=green] and set[innerHTML='test 1 passed']
				else set[color=blue] and set[innerHTML='test 2 passed']">
				Hello
			</div>
		</td>
	</tr>
	<tr>
		<td class="test" valign="middle">
			"else" Test (state machine)
		</td>
		<td class="result">
			<a on="click then l:statetest[valid=true]">State Valid</a> |
			<a on="click then l:statetest[valid=false]">State Invalid</a> 

			<div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" 
				on="test[valid] then set[innerHTML='state valid, test passed']
				else set[innerHTML='state invalid, test passed']">
				Hello
			</div>
		</td>
	</tr>
    <tr>
        <td class="test" valign="middle">
            Dynamic element property
        </td>
        <td class="result">
            <input type="hidden" id="hidden_input" value="Test passed"/>
			<a on="click then l:set.field[result=$hidden_input]">Click to run</a>

            <div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" 
                on="l:set.field then value[result]">
                Waiting on click...
            </div>
        </td>
    </tr> 
    <tr>
        <td class="test" valign="middle">
            Dynamic javascript property
        </td>
        <td class="result">
            <a on="click then l:set.field2[result=expr(someGlobalVariable)]">Click to run</a>

            <div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" 
                on="l:set.field2 then value[result]">
                Waiting on click...
            </div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            Dynamic javascript property, with leading and trailing whitespaces
        </td>
        <td class="result">
            <a on="click then l:set.test.whitespace1[ result=expr(someGlobalVariable) ]">Click to run</a>

            <div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" 
                on="l:set.test.whitespace1 then value[result]">
                Waiting on click...
            </div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            Dynamic javascript property, with whitespace all over the place
        </td>
        <td class="result">
            <a on="click then l:set.test.whitespace2[ result = expr( 1 + 1 ) ]">Click to run</a>

            <div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" 
                on="l:set.test.whitespace2 then value[result]">
                Replaced by 2 when test passes.......
            </div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            Dynamic javascript property by calling function
        </td>
        <td class="result">
            <a on="click then l:set.field3[result=expr(someGlobalFunction())]">Click to run</a>

            <div style="background-color:#ffffcc;border:1px solid #999;padding:5px;margin-top:2px" 
                on="l:set.field3 then value[result]">
                Waiting on click...
            </div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            Children based conditions
        </td>
        <td class="result">
        	<div>
        		<ul on="children.click then l:child.test1.passed">
        			<li>Click me</li>
                    <li>Or click me</li>
                    <li>Or event click me</li>
        		</ul>
        	</div>
			<div style="display:none" on="l:child.test1.passed then show">
				Test passed
			</div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            Selected with embedded quotes
        </td>
        <td class="result">
            <app:iterator on="l:test.embed then execute" property="rows" selectable="test.embed">
				<html:div on="selected then l:child.test2.passed[id=&quot;#{test}&quot;]">
				#{test}
				</html:div>
			</app:iterator>
			<app:message name="l:test.embed" args="{rows:[{'test':'Click me'}]}"></app:message> 
            <div style="display:none" on="l:child.test2.passed[id='Click me'] then show">
                Test passed
            </div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            <!-- APPSDK-100 Code tabs are broken in opera-->
            Message with right hand side of a parameter equal to the name of an input.
        </td>
        <td class="result">
            <a on="click then l:appsdk100[show=code]">Click to run</a>
            <div style="display:none" on="l:appsdk100[show=code] then show">
                <input name="code" type="text" disabled="true" value="Test Passed" />
            </div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            <!-- APPSDK-153 Enforce Ordering In Local Service Broker -->
            Correct message ordering in local service broker
        </td>
        <td class="result">
			<a on="click then l:appsdk153.one">Click to run</a>

			<app:script on="l:appsdk153.one then execute">
			$MQ('l:appsdk153.two');
			</app:script>

			<app:script on="l:appsdk153.one then javascript[alert('you should see this first')] or l:appsdk153.two then javascript[alert('you should see this second')]">	
			</app:script>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            <!-- APPSDK-339 Local/Remote Messages Not Being Respected -->
            Local message listeners should not match remote messages
        </td>
        <td class="result">
			<a on="click then l:appsdk339.one">Click to run</a>

			<app:script on="l:appsdk339.one then execute">
				alert('you should see this only once, test passed');
				$MQ('r:appsdk339.one');
			</app:script>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            <!-- APPSDK-344 Message conditionals no longer function -->
			Test message conditionals (guards on the message payload)
        </td>
        <td class="result">

<div on="r:remote.message.response then show" style="display: none">Baseline</div>
<div on="r:remote.message.response[success=true] then show" style="display: none;">Test Passed</div>
<div on="r:remote.message.response[success=false] then show" style="display: none;">Test Failed</div>

<app:message
	on="l:app.compiled then execute"
	name="r:remote.message.response"
	args="{'success': true}"></app:message

		</td>
	</tr>
	<tr>
        <td class="test" valign="middle">
            <!-- APPSDK-532 Message payload is not passed correctly  -->
            Message payload is not passed correctly into the script action
        </td>
        <td class="result">
			<a on="click then l:appsdk532.one[text='Test Passed']">Click to run</a>

            <div on="l:appsdk532.one then script[$(this.data.id).innerHTML = this.data.text]"></div>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            Use Id in an expression for input
        </td>
        <td class="result">
            <input type="text" name="blah" value="Empty then blur" 
                    on="blur then value[Test Passed] if expr[$(this.id).value.length == 0]"/>
        </td>
    </tr>
    <tr>
        <td class="test" valign="middle">
            <!-- APPSDK-532 Message payload is not passed correctly  -->
            Test this.data in expression
        </td>
        <td class="result">
            <a on="click then l:appsdk532.two[test=true]">Click to run</a>

            <div on="l:appsdk532.two then value[Test Passed] if expr[this.data.test]"></div>
        </td>
    </tr>
	<tr>
		<td class="test">Programmatic "on" expressions</td>
		<td class="result" id="p_on1">
			Failed
		</td>
	</tr>
	<tr>
		<td class="test">Programmatic "on" expressions as array</td>
		<td class="result" id="p_on2">
			Failed
		</td>
	</tr>
	<tr>
		<td class="test">Programmatic condition listener</td>
		<td class="result" id="p_cl1">
			Failed
		</td>
	</tr>
	<tr>
		<td class="test">Programmatic on expressions using functions</td>
		<td class="result"> 
			<div id="p_onex1r"></div>
		</td>
	</tr>
	<tr>
		<td class="test">Programmatic on expressions using functions (event)</td>
		<td class="result"> 
			<div id="p_onex2r">Click me</div>
		</td>
	</tr>
	<tr>
		<td class="test">Programmatic on expressions using functions (else in message)</td>
		<td class="result"> 
			<div id="p_onex3r">Click me</div>
		</td>
	</tr>
</table>

<app:statemachine id="test" initial="valid">
	<state name="invalid" if="l:statetest[valid=false]"></state>
	<state name="valid" if="l:statetest[valid=true]"></state>
</app:statemachine>

<script>
$('p_on1').on("l:app.compiled then value['passed']");
$$('#p_on2').on("l:app.compiled then value['passed']");

$('p_onex1r').on('l:test.p.on',function()
{
	if (this.data && this.data.rows && this.data.rows[0]=='1')
	{
		$('p_onex1r').innerHTML='Passed';
	}
	else
	{
		$('p_onex1r').innerHTML='Failed - data payload missing';
	}
});
$('p_onex2r').on('click',function()
{
	$('p_onex2r').innerHTML = 'Passed';
});
$('p_onex3r').on('l:test.p.on[foo]',function()
{
	$('p_onex3r').innerHTML = 'Failed';
},function()
{
	$('p_onex3r').innerHTML = 'Passed';
});

$MQ('l:test.p.on',{
	'rows':[1,2,3]
});


Appcelerator.Compiler.registerConditionListener($('p_cl1'),'foo',function(element,condition)
{
	if (element.id != 'p_cl1')
	{
		$('p_cl1').innerHTML = "Failed: element.id in parameter didn't match. Expected: p_cl1, was: "+element.id;
		return;
	}
	if (condition != 'foo')
	{
		$('p_cl1').innerHTML = "Failed: condition in parameter didn't match. Expected 'foo', was: "+condition;
		return;
	}
	element.innerHTML = 'passed';
});

Appcelerator.Compiler.fireConditionEvent($('p_cl1'),'foo');

</script>

</body>
</html>
