#
# This file is part of Appcelerator.
#
# Copyright (c) 2006-2008, Appcelerator, Inc.
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without modification,
# are permitted provided that the following conditions are met:
# 
#     * Redistributions of source code must retain the above copyright notice,
#       this list of conditions and the following disclaimer.
# 
#     * Redistributions in binary form must reproduce the above copyright notice,
#       this list of conditions and the following disclaimer in the documentation
#       and/or other materials provided with the distribution.
# 
#     * Neither the name of Appcelerator, Inc. nor the names of its
#       contributors may be used to endorse or promote products derived from this
#       software without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
# ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
# ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
BUILD_DIR = File.dirname(__FILE__)
require File.expand_path("#{BUILD_DIR}/build.rb")

task :default => [:all] do
end

task :all => %w(widget:all layout:all behavior:all control:all theme:all service:all websdk:all installer:all plugin:all) do
end

namespace :layout do
  
  task :all do 
    FileUtils.cd(File.expand_path("#{BUILD_DIR}/layouts")) do |d|
      call_rake " all"
    end
  end

end

namespace :control do
  
  task :all do 
    FileUtils.cd(File.expand_path("#{BUILD_DIR}/controls")) do |d|
      call_rake " all"
    end
  end

end

namespace :behavior do
  
  task :all do 
    FileUtils.cd(File.expand_path("#{BUILD_DIR}/behaviors")) do |d|
      call_rake " all"
    end
  end

end

namespace :theme do
  
  task :all do 
    FileUtils.cd(File.expand_path("#{BUILD_DIR}/themes")) do |d|
      call_rake " all"
    end
  end

end

namespace :installer do
  
  task :all do 
    FileUtils.cd(File.expand_path("#{BUILD_DIR}/runtime")) do |d|
      call_rake " all"
    end
  end

  task :win32 do
    FileUtils.cd("#{BUILD_DIR}/runtime") do |d|
      call_rake " win32"
    end
  end

  task :unix do
    FileUtils.cd("#{BUILD_DIR}/runtime") do |d|
      call_rake " unix"
    end
  end

  task :osx do
    FileUtils.cd("#{BUILD_DIR}/runtime") do |d|
      call_rake " osx"
    end
  end

  task :update do
    FileUtils.cd("#{BUILD_DIR}/runtime") do |d|
      call_rake " update"
    end
  end
    
end

namespace :websdk do
  desc "Build the websdk"
  task :all do
    FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
      call_rake ""
    end
  end
  
  # task :test do
  #   FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
  #     call_rake " test"
  #   end
  # end
  
  desc "Run the default set of tests (requires JAVA)"
  task :test => 'test:default'
  namespace :test do
    task :default do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " test"
        end
    end
      
    task :webunit do 
      FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
        call_rake " test"
      end
    end
    
    namespace :selenium do 
      task :start do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " selenium:start"
        end
      end
      
      task :stop do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " selenium:stop"
        end
      end
      
      task :all do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " selenium:all"
        end
      end
      
      task :firefox do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " selenium:firefox"
        end
      end
      
      task :safari do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " selenium:safari"
        end
      end
      
      task :ie do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " selenium:ie"
        end
      end
    end
    
    namespace :webrick do 
      task :start do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " webrick:start"
        end
      end
      
      task :stop do 
        FileUtils.cd("#{BUILD_DIR}/websdk") do |d|
          call_rake " webrick:stop"
        end
      end
    end
  end
end

namespace :widget do
  
  task :all do
    FileUtils.cd("#{BUILD_DIR}/widgets") do |d|
      call_rake ""
    end
  end

end

namespace :service do
  
  task :all do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " all"
    end
  end

  task :java do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " java"
    end
  end

  task :python do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " python"
    end
  end

  task :appengine do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " appengine"
    end
  end

  task :dotnet do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " dotnet"
    end
  end

  task :ruby do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " ruby"
    end
  end

  task :perl do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " perl"
    end
  end

  task :php do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " php"
    end
  end

  task :zend do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " zend"
    end
  end

  task :merb do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " merb"
    end
  end

  task :mule do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " mule"
    end
  end

  task :struts do
    FileUtils.cd("#{BUILD_DIR}/services") do |d|
      call_rake " struts"
    end
  end

end

namespace :plugin do
  task :all do
    FileUtils.cd("#{BUILD_DIR}/plugins") do |d|
      call_rake ""
    end
  end

  task :java do
    FileUtils.cd("#{BUILD_DIR}/plugins") do |d|
      call_rake " java:all"
    end
  end

  task :java_spring do
    FileUtils.cd("#{BUILD_DIR}/plugins") do |d|
      call_rake " java:spring"
    end
  end
end


#
# this is a nolan special
#
namespace :release do
  task :all do
    server = ENV['UPDATESITE'] || ENV['SERVER'] || 'http://updatesite.appcelerator.org'
    puts "==> releasing all widgets"
    system "app release #{STAGE_DIR}/all_widgets.zip --server=#{server}"
    puts "==> releasing websdk"
    system "app release #{Dir.glob(STAGE_DIR + '/websdk_*.zip').first} --server=#{server}"
    puts "==> releasing installer_update"
    system "app release #{Dir.glob(STAGE_DIR + '/installer_update_*.zip').first} --server=#{server}"

    %w(service installer plugin layout control behavior theme).each do |type|
      Dir.glob("#{STAGE_DIR}/#{type}_*.zip").each do |name|
        puts "==> releasing #{File.basename(name)}"
        system "app release #{name} --server=#{server}"
      end
    end
  end
end
